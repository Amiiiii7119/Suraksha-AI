<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Suraksha AI ‚Äî Workplace Safety Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800;900&family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --red: #FF2D2D;
    --red-dim: #cc1e1e;
    --yellow: #FFD600;
    --green: #00FF94;
    --bg: #080A0E;
    --surface: #0F1117;
    --surface2: #161B27;
    --border: #1E2535;
    --text: #E8EAF0;
    --text-dim: #5A6480;
    --text-mid: #8892B0;
    --font-head: 'Syne', sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
    --font-body: 'Inter', sans-serif;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:var(--font-body); min-height:100vh; overflow-x:hidden; }

  body::before {
    content:''; position:fixed; inset:0; pointer-events:none; z-index:9999;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,.015) 2px, rgba(255,255,255,.015) 4px);
  }

  /* NAV */
  nav {
    position:fixed; top:0; left:0; right:0; z-index:100;
    height:64px; background:rgba(8,10,14,.9); backdrop-filter:blur(16px);
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; padding:0 24px; gap:32px;
  }
  .logo { font-family:var(--font-head); font-size:20px; font-weight:900; color:var(--red); letter-spacing:2px; white-space:nowrap; }
  .logo span { color:var(--text); }
  .nav-links { display:flex; gap:4px; flex:1; }
  .nav-btn {
    padding:8px 16px; border:none; background:transparent; color:var(--text-mid);
    font-family:var(--font-mono); font-size:11px; font-weight:700; letter-spacing:1px;
    cursor:pointer; transition:all .2s; border-radius:4px; text-transform:uppercase;
  }
  .nav-btn:hover { color:var(--text); background:var(--surface2); }
  .nav-btn.active { color:var(--red); background:rgba(255,45,45,.08); }
  .nav-status { display:flex; align-items:center; gap:8px; font-family:var(--font-mono); font-size:11px; color:var(--text-dim); }
  .pulse-dot { width:8px; height:8px; border-radius:50%; background:var(--green); animation:pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(.8)} }

  /* PAGES */
  .page { display:none; padding:80px 24px 40px; max-width:1400px; margin:0 auto; }
  .page.active { display:block; }

  /* SECTION HEADER */
  .section-header { margin-bottom:32px; }
  .section-label { font-family:var(--font-mono); font-size:11px; color:var(--red); letter-spacing:3px; margin-bottom:8px; }
  .section-title { font-family:var(--font-head); font-size:36px; font-weight:900; color:var(--text); letter-spacing:-1px; }

  /* CARDS */
  .card { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:24px; }
  .card-title { font-family:var(--font-mono); font-size:11px; font-weight:700; color:var(--text-dim); letter-spacing:2px; margin-bottom:16px; }

  /* BUTTONS */
  .btn {
    padding:12px 24px; border:none; border-radius:6px; cursor:pointer;
    font-family:var(--font-mono); font-size:12px; font-weight:700; letter-spacing:1px;
    transition:all .2s; text-transform:uppercase;
  }
  .btn-red { background:var(--red); color:#fff; }
  .btn-red:hover { background:var(--red-dim); transform:translateY(-1px); box-shadow:0 4px 16px rgba(255,45,45,.3); }
  .btn-red:disabled { background:#333; color:#666; cursor:not-allowed; transform:none; box-shadow:none; }
  .btn-ghost { background:transparent; color:var(--text-dim); border:1px solid var(--border); }
  .btn-ghost:hover { border-color:var(--red); color:var(--red); }
  .btn-ghost:disabled { opacity:.4; cursor:not-allowed; }
  .btn-green { background:var(--green); color:#000; }
  .btn-green:hover { opacity:.9; }

  /* TAGS */
  .tag { display:inline-block; padding:4px 10px; border-radius:4px; font-family:var(--font-mono); font-size:10px; font-weight:700; letter-spacing:1px; }
  .tag-red { background:rgba(255,45,45,.15); color:var(--red); border:1px solid rgba(255,45,45,.3); }
  .tag-yellow { background:rgba(255,214,0,.1); color:var(--yellow); border:1px solid rgba(255,214,0,.3); }
  .tag-green { background:rgba(0,255,148,.1); color:var(--green); border:1px solid rgba(0,255,148,.3); }

  /* DASHBOARD */
  .metrics-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:24px; }
  .metric-card {
    background:var(--surface); border:1px solid var(--border); border-radius:8px;
    padding:20px; position:relative; overflow:hidden;
  }
  .metric-card::after {
    content:''; position:absolute; top:0; left:0; right:0; height:2px;
    background:linear-gradient(90deg, transparent, var(--red), transparent);
    opacity:0; transition:.3s;
  }
  .metric-card:hover::after { opacity:1; }
  .metric-label { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); letter-spacing:2px; margin-bottom:8px; }
  .metric-value { font-family:var(--font-mono); font-size:32px; font-weight:700; color:var(--text); }
  .metric-sub { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); margin-top:4px; }
  .metric-trend { position:absolute; top:20px; right:20px; font-family:var(--font-mono); font-size:12px; }
  .trend-up { color:var(--red); }
  .trend-down { color:var(--green); }

  .risk-bar-container { margin-bottom:24px; }
  .risk-bar-label { display:flex; justify-content:space-between; font-family:var(--font-mono); font-size:11px; color:var(--text-dim); margin-bottom:8px; }
  .risk-bar-track { height:8px; background:var(--surface2); border-radius:4px; overflow:hidden; }
  .risk-bar-fill { height:100%; border-radius:4px; transition:width 1s ease; }

  .dashboard-grid { display:grid; grid-template-columns:2fr 1fr; gap:16px; }
  .events-list { display:flex; flex-direction:column; gap:8px; max-height:320px; overflow-y:auto; }
  .events-list::-webkit-scrollbar { width:4px; }
  .events-list::-webkit-scrollbar-track { background:var(--surface2); }
  .events-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
  .event-item {
    display:flex; align-items:center; gap:12px;
    padding:12px 16px; background:var(--surface2); border-radius:6px;
    border-left:3px solid transparent; transition:.2s;
    animation: slideIn .3s ease;
  }
  @keyframes slideIn { from{opacity:0;transform:translateX(-8px)} to{opacity:1;transform:none} }
  .event-item.critical { border-left-color:var(--red); }
  .event-item.medium { border-left-color:var(--yellow); }
  .event-item.low { border-left-color:var(--green); }
  .event-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
  .event-dot.critical { background:var(--red); box-shadow:0 0 6px var(--red); }
  .event-dot.medium { background:var(--yellow); box-shadow:0 0 6px var(--yellow); }
  .event-dot.low { background:var(--green); box-shadow:0 0 6px var(--green); }
  .event-text { flex:1; font-size:13px; color:var(--text); }
  .event-zone { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); }
  .event-time { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); white-space:nowrap; }

  .pathway-panel {
    background:var(--surface); border:1px solid var(--border); border-radius:8px;
    padding:20px; border-top:2px solid var(--green);
  }
  .pathway-label { font-family:var(--font-mono); font-size:10px; color:var(--green); letter-spacing:2px; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
  .pathway-stream { font-family:var(--font-mono); font-size:11px; color:var(--text-dim); line-height:1.8; max-height:240px; overflow-y:auto; }
  .pathway-stream::-webkit-scrollbar { width:3px; }
  .pathway-stream::-webkit-scrollbar-thumb { background:var(--green); border-radius:2px; }
  .pathway-line { padding:2px 0; border-bottom:1px solid rgba(255,255,255,.03); }
  .pathway-line.new { color:var(--green); animation:fadeGreen 2s ease forwards; }
  @keyframes fadeGreen { 0%{color:var(--green)} 100%{color:var(--text-dim)} }
  .pathway-ts { color:var(--text-dim); }
  .pathway-event { color:var(--yellow); }
  .pathway-score { color:var(--red); }

  /* DETECTION */
  .detect-grid { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
  .upload-zone {
    border:2px dashed var(--border); border-radius:8px; padding:48px 32px;
    text-align:center; cursor:pointer; transition:all .3s;
    background:var(--surface); position:relative; overflow:hidden;
  }
  .upload-zone:hover, .upload-zone.dragover { border-color:var(--red); background:rgba(255,45,45,.05); }
  .upload-zone input[type=file] { position:absolute; inset:0; opacity:0; cursor:pointer; }
  .upload-icon { font-size:48px; margin-bottom:16px; }
  .upload-title { font-family:var(--font-head); font-size:20px; font-weight:700; color:var(--text); margin-bottom:8px; }
  .upload-sub { font-size:13px; color:var(--text-dim); }
  .upload-formats { display:flex; gap:8px; justify-content:center; margin-top:16px; flex-wrap:wrap; }
  .upload-preview { margin-top:16px; border-radius:6px; overflow:hidden; max-height:300px; }
  .upload-preview img, .upload-preview video { width:100%; border-radius:6px; max-height:280px; object-fit:contain; }

  /* LIVE CAMERA CARD */
  .live-cam-feed-wrap {
    position:relative; background:#000; border-radius:6px; overflow:hidden; min-height:220px;
    display:flex; align-items:center; justify-content:center;
  }
  #liveCamFeed { width:100%; max-height:260px; object-fit:cover; display:none; border-radius:6px; }
  #liveCamCanvas { display:none; }
  .live-cam-placeholder {
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    height:220px; gap:12px; opacity:.4;
  }
  .live-cam-placeholder .icon { font-size:48px; }
  .cam-overlay-badge {
    position:absolute; top:10px; left:10px;
    background:rgba(255,45,45,.85); color:#fff;
    font-family:var(--font-mono); font-size:10px; font-weight:700; letter-spacing:1px;
    padding:4px 10px; border-radius:4px;
    display:none; align-items:center; gap:6px;
  }
  .cam-overlay-badge.active { display:flex; }
  .cam-overlay-dot { width:7px; height:7px; border-radius:50%; background:#fff; animation:pulse 1s infinite; }
  .cam-snap-overlay {
    position:absolute; inset:0; background:rgba(255,255,255,.15);
    pointer-events:none; opacity:0; transition:opacity .1s;
    border-radius:6px;
  }
  .cam-snap-overlay.flash { opacity:1; }

  .detect-result { display:flex; flex-direction:column; gap:16px; }
  .violations-list { display:flex; flex-direction:column; gap:8px; max-height:300px; overflow-y:auto; }
  .violation-item {
    display:flex; align-items:center; gap:12px;
    padding:12px; background:var(--surface2); border-radius:6px;
  }
  .violation-icon { font-size:20px; }
  .violation-name { flex:1; font-size:13px; font-weight:600; color:var(--text); }
  .confidence-bar { height:4px; background:var(--border); border-radius:2px; margin-top:4px; overflow:hidden; }
  .confidence-fill { height:100%; border-radius:2px; background:var(--red); }
  .violation-conf { font-family:var(--font-mono); font-size:11px; color:var(--text-dim); }

  .no-result {
    flex:1; display:flex; align-items:center; justify-content:center;
    flex-direction:column; gap:16px; padding:48px; text-align:center;
    background:var(--surface2); border-radius:8px;
  }
  .no-result-icon { font-size:48px; opacity:.3; }
  .no-result-text { color:var(--text-dim); font-size:14px; }

  .pw-metric { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:20px; }
  .pw-metric-title { font-family:var(--font-mono); font-size:10px; color:var(--green); letter-spacing:2px; margin-bottom:12px; }
  .pw-metric-val { font-family:var(--font-mono); font-size:28px; font-weight:700; }
  .pw-metric-desc { font-size:12px; color:var(--text-dim); margin-top:4px; }

  /* LEADERBOARD */
  .podium { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:32px; align-items:end; }
  .podium-card {
    background:var(--surface); border:1px solid var(--border); border-radius:8px;
    padding:24px; text-align:center; position:relative; overflow:hidden;
  }
  .podium-card.first {
    border-color:rgba(255,214,0,.4);
    background:linear-gradient(180deg, rgba(255,214,0,.06) 0%, var(--surface) 100%);
    transform:translateY(-16px);
  }
  .podium-card.second { border-color:rgba(176,176,176,.3); }
  .podium-card.third { border-color:rgba(205,127,50,.3); }
  .podium-medal { font-size:40px; margin-bottom:12px; }
  .podium-rank { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); letter-spacing:2px; margin-bottom:4px; }
  .podium-name { font-family:var(--font-head); font-size:18px; font-weight:800; color:var(--text); margin-bottom:4px; }
  .podium-zone { font-size:12px; color:var(--text-dim); margin-bottom:16px; }
  .podium-score { font-family:var(--font-mono); font-size:28px; font-weight:700; color:var(--yellow); }
  .podium-score-label { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); }
  .podium-card.first::before {
    content:''; position:absolute; inset:-2px; border-radius:9px;
    background:linear-gradient(135deg,rgba(255,214,0,.3),transparent,rgba(255,214,0,.1));
    z-index:0; pointer-events:none;
  }

  .lb-table { background:var(--surface); border:1px solid var(--border); border-radius:8px; overflow:hidden; }
  .lb-table-header {
    display:grid; grid-template-columns:60px 1fr 120px 100px 120px 80px;
    padding:12px 20px; background:var(--surface2);
    font-family:var(--font-mono); font-size:10px; color:var(--text-dim); letter-spacing:2px;
    border-bottom:1px solid var(--border);
  }
  .lb-row {
    display:grid; grid-template-columns:60px 1fr 120px 100px 120px 80px;
    padding:16px 20px; border-bottom:1px solid var(--border);
    transition:.2s; align-items:center;
  }
  .lb-row:last-child { border-bottom:none; }
  .lb-row:hover { background:rgba(255,255,255,.02); }
  .lb-rank { font-family:var(--font-mono); font-size:16px; font-weight:700; }
  .lb-rank.top { color:var(--yellow); }
  .lb-name { font-weight:600; color:var(--text); font-size:14px; }
  .lb-zone { font-size:13px; color:var(--text-dim); }
  .lb-points { font-family:var(--font-mono); font-size:18px; font-weight:700; color:var(--yellow); }

  .zone-battle { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; margin-bottom:32px; }
  .zone-card { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:20px; }
  .zone-name { font-family:var(--font-head); font-size:14px; font-weight:800; letter-spacing:1px; margin-bottom:12px; }
  .zone-progress { height:6px; background:var(--surface2); border-radius:3px; overflow:hidden; margin-bottom:8px; }
  .zone-progress-fill { height:100%; border-radius:3px; transition:width 1s ease; }
  .zone-stats { display:flex; justify-content:space-between; font-family:var(--font-mono); font-size:11px; color:var(--text-dim); }
  .my-rank-card {
    background:var(--surface); border:2px solid var(--red); border-radius:8px;
    padding:24px; display:flex; justify-content:space-between; align-items:center;
    margin-bottom:32px;
  }
  .my-avatar {
    width:48px; height:48px; border-radius:50%; background:var(--red);
    display:flex; align-items:center; justify-content:center;
    font-family:var(--font-head); font-size:20px; font-weight:900; color:#fff;
  }
  .my-info { flex:1; padding:0 20px; }
  .my-name { font-family:var(--font-head); font-size:20px; font-weight:800; }
  .my-sub { font-size:13px; color:var(--text-dim); }
  .my-points { text-align:right; }
  .my-points-num { font-family:var(--font-mono); font-size:40px; font-weight:700; color:var(--yellow); }
  .my-points-label { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); letter-spacing:2px; }

  /* PATHWAY LIVE */
  .pathway-full { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
  .terminal {
    background:#000; border:1px solid var(--green); border-radius:8px;
    padding:20px; font-family:var(--font-mono); font-size:12px;
    max-height:480px; overflow-y:auto;
  }
  .terminal::-webkit-scrollbar { width:4px; }
  .terminal::-webkit-scrollbar-thumb { background:var(--green); border-radius:2px; }
  .terminal-header { color:var(--green); margin-bottom:16px; border-bottom:1px solid rgba(0,255,148,.2); padding-bottom:8px; }
  .t-line { color:#5A6480; line-height:1.7; }
  .t-line .t-green { color:var(--green); }
  .t-line .t-yellow { color:var(--yellow); }
  .t-line .t-red { color:var(--red); }
  .t-line .t-white { color:var(--text); }
  .t-line.new-entry { animation:terminalNew .5s ease; }
  @keyframes terminalNew { from{background:rgba(0,255,148,.1)} to{background:transparent} }

  .pathway-metrics { display:flex; flex-direction:column; gap:16px; }

  .event-chart { display:flex; align-items:flex-end; gap:4px; height:80px; margin-top:8px; }
  .chart-bar {
    flex:1; border-radius:3px 3px 0 0; transition:height .5s ease;
    background:linear-gradient(180deg, var(--red), rgba(255,45,45,.3));
    min-height:2px;
  }

  /* ‚îÄ‚îÄ RAG STATUS BADGE (new, no layout impact) ‚îÄ‚îÄ */
  .rag-status-row {
    display:flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:6px;
    background:var(--surface2); margin-bottom:12px;
    font-family:var(--font-mono); font-size:10px; letter-spacing:1px;
  }
  .rag-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
  .rag-dot.live { background:var(--green); box-shadow:0 0 6px var(--green); animation:pulse 1.5s infinite; }
  .rag-dot.pending { background:var(--yellow); }
  .rag-dot.off { background:var(--text-dim); }

  /* AUTH */
  .auth-overlay {
    position:fixed; inset:0; background:rgba(8,10,14,.98); z-index:200;
    display:flex; align-items:center; justify-content:center;
  }
  .auth-box {
    background:var(--surface); border:1px solid var(--border); border-radius:12px;
    padding:48px; width:420px;
  }
  .auth-logo { font-family:var(--font-head); font-size:28px; font-weight:900; color:var(--red); margin-bottom:8px; letter-spacing:2px; }
  .auth-sub { font-size:14px; color:var(--text-dim); margin-bottom:32px; }
  .auth-field { margin-bottom:16px; }
  .auth-label { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); letter-spacing:2px; margin-bottom:6px; }
  .auth-input {
    width:100%; padding:12px 16px; background:var(--surface2); border:1px solid var(--border);
    border-radius:6px; color:var(--text); font-family:var(--font-body); font-size:14px;
    outline:none; transition:.2s;
  }
  .auth-input:focus { border-color:var(--red); }
  .auth-error { color:var(--red); font-size:12px; margin-top:8px; display:none; }
  .auth-toggle { margin-top:16px; text-align:center; font-size:13px; color:var(--text-dim); }
  .auth-toggle span { color:var(--red); cursor:pointer; }
  .loading-spinner {
    width:16px; height:16px; border:2px solid rgba(255,255,255,.3);
    border-top-color:#fff; border-radius:50%; animation:spin .8s linear infinite; display:none;
  }
  @keyframes spin { to{transform:rotate(360deg)} }

  /* TOAST */
  .toast-container { position:fixed; top:80px; right:24px; z-index:300; display:flex; flex-direction:column; gap:8px; }
  .toast {
    padding:12px 20px; border-radius:6px; font-family:var(--font-mono); font-size:12px;
    border-left:3px solid; animation:toastIn .3s ease; max-width:320px;
  }
  .toast.success { background:#0a2a1a; border-color:var(--green); color:var(--green); }
  .toast.error { background:#2a0a0a; border-color:var(--red); color:var(--red); }
  .toast.info { background:#1a1a0a; border-color:var(--yellow); color:var(--yellow); }
  @keyframes toastIn { from{opacity:0;transform:translateX(16px)} to{opacity:1;transform:none} }

  /* VIOLATION ALERT POPUP */
  .violation-popup {
    position:fixed; top:80px; left:50%; transform:translateX(-50%);
    z-index:500; width:480px; max-width:92vw;
    border-radius:10px; padding:20px 24px;
    animation:toastIn .3s ease;
  }
  .violation-popup.critical {
    background:rgba(20,5,5,.97); border:2px solid var(--red);
    box-shadow:0 0 48px rgba(255,45,45,.4);
  }
  .violation-popup.warning {
    background:rgba(20,16,5,.97); border:2px solid var(--yellow);
    box-shadow:0 0 32px rgba(255,214,0,.2);
  }
  .popup-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
  .popup-title { display:flex; align-items:center; gap:10px; }
  .popup-title-dot { width:10px; height:10px; border-radius:50%; animation:pulse 1s infinite; }
  .popup-title-text { font-family:var(--font-head); font-size:17px; font-weight:900; letter-spacing:1px; }
  .popup-close {
    background:transparent; border:none; color:var(--text-dim);
    font-size:18px; cursor:pointer; padding:0 4px; line-height:1;
  }
  .popup-viol-row {
    display:flex; align-items:center; gap:12px;
    padding:9px 12px; background:rgba(255,255,255,.04);
    border-radius:6px; margin-bottom:6px;
  }
  .popup-viol-icon { font-size:20px; }
  .popup-viol-name { flex:1; font-weight:700; font-size:13px; color:var(--text); }
  .popup-viol-conf { font-family:var(--font-mono); font-size:12px; }
  .popup-viol-zone { font-family:var(--font-mono); font-size:11px; color:var(--text-dim); }
  .popup-footer { display:flex; justify-content:space-between; align-items:center; margin-top:12px; padding-top:10px; border-top:1px solid rgba(255,255,255,.06); }
  .popup-risk { font-family:var(--font-mono); font-size:12px; color:var(--text-dim); }
  .popup-time { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); }
  .popup-dismiss-bar {
    height:3px; border-radius:2px; margin-top:10px;
    background:rgba(255,255,255,.1); overflow:hidden;
  }
  .popup-dismiss-fill {
    height:100%; border-radius:2px;
    animation:dismissProgress 6s linear forwards;
  }
  @keyframes dismissProgress { from{width:100%} to{width:0%} }

  /* MISC */
  .flex { display:flex; }
  .gap-16 { gap:16px; }
  .gap-8 { gap:8px; }
  .align-center { align-items:center; }
  .justify-between { justify-content:space-between; }
  .mt-16 { margin-top:16px; }
  .mt-24 { margin-top:24px; }
  .mb-16 { margin-bottom:16px; }
  .mb-24 { margin-bottom:24px; }
  .text-dim { color:var(--text-dim); }
  .text-mono { font-family:var(--font-mono); }
  .text-red { color:var(--red); }
  .text-green { color:var(--green); }
  .text-yellow { color:var(--yellow); }
  .full-width { width:100%; }
  .separator { height:1px; background:var(--border); margin:24px 0; }

  .empty-state { padding:60px 40px; text-align:center; background:var(--surface2); border-radius:8px; }
  .empty-state-icon { font-size:48px; margin-bottom:16px; opacity:.4; }
  .empty-state-title { font-family:var(--font-head); font-size:18px; font-weight:700; color:var(--text-dim); margin-bottom:8px; }
  .empty-state-sub { font-size:13px; color:var(--text-dim); }

  select.auth-input { appearance:none; }
  .select-wrap { position:relative; }
  .select-wrap::after {
    content:'‚ñº'; position:absolute; right:12px; top:50%; transform:translateY(-50%);
    font-size:10px; color:var(--text-dim); pointer-events:none;
  }

  @media(max-width:900px) {
    .metrics-grid { grid-template-columns:repeat(2,1fr); }
    .dashboard-grid { grid-template-columns:1fr; }
    .detect-grid { grid-template-columns:1fr; }
    .pathway-full { grid-template-columns:1fr; }
    .lb-table-header, .lb-row { grid-template-columns:50px 1fr 100px 100px; }
    .lb-scans, .lb-status { display:none; }
    .podium { grid-template-columns:1fr; }
    .podium-card.first { transform:none; }
    .zone-battle { grid-template-columns:1fr; }
  }
</style>
</head>
<body>

<!-- AUTH OVERLAY -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-box">
    <div class="auth-logo">SURAKSHA<span style="color:var(--text)"> AI</span></div>
    <div class="auth-sub">Workplace Safety Intelligence Platform</div>

    <div id="loginForm">
      <div class="auth-field">
        <div class="auth-label">EMAIL ADDRESS</div>
        <input class="auth-input" type="email" id="loginEmail" placeholder="admin@company.com" value="amteshwarrajsingh@gmail.com">
      </div>
      <div class="auth-field">
        <div class="auth-label">PASSWORD</div>
        <input class="auth-input" type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="admin123">
      </div>
      <div class="auth-error" id="loginError">Invalid credentials. Please try again.</div>
      <button class="btn btn-red full-width mt-16" style="display:flex;align-items:center;justify-content:center;gap:8px;" onclick="doLogin()">
        <span>SIGN IN</span>
        <div class="loading-spinner" id="loginSpinner"></div>
      </button>
      <div class="auth-toggle">Don't have an account? <span onclick="showRegister()">Create one</span></div>
    </div>

    <div id="registerForm" style="display:none;">
      <div class="auth-field">
        <div class="auth-label">FULL NAME</div>
        <input class="auth-input" type="text" id="regName" placeholder="Your Name">
      </div>
      <div class="auth-field">
        <div class="auth-label">EMAIL ADDRESS</div>
        <input class="auth-input" type="email" id="regEmail" placeholder="you@company.com">
      </div>
      <div class="auth-field">
        <div class="auth-label">PASSWORD</div>
        <input class="auth-input" type="password" id="regPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="auth-field">
        <div class="auth-label">ROLE</div>
        <div class="select-wrap">
          <select class="auth-input" id="regRole">
            <option value="viewer">Viewer</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
      <div class="auth-error" id="regError">Registration failed.</div>
      <button class="btn btn-red full-width mt-16" style="display:flex;align-items:center;justify-content:center;gap:8px;" onclick="doRegister()">
        <span>CREATE ACCOUNT</span>
        <div class="loading-spinner" id="regSpinner"></div>
      </button>
      <div class="auth-toggle">Already have an account? <span onclick="showLogin()">Sign in</span></div>
    </div>
  </div>
</div>

<!-- NAV -->
<nav>
  <div class="logo">SURAKSHA<span> AI</span></div>
  <div class="nav-links">
    <button class="nav-btn active" onclick="showPage('dashboard',this)">DASHBOARD</button>
    <button class="nav-btn" onclick="showPage('detection',this)">DETECTION</button>
    <button class="nav-btn" onclick="showPage('leaderboard',this)">LEADERBOARD</button>
    <button class="nav-btn" onclick="showPage('pathway',this)">PATHWAY LIVE</button>
  </div>
  <div class="nav-status">
    <div class="pulse-dot"></div>
    <span id="navStatus">LIVE</span>
    <span style="margin-left:16px;cursor:pointer;color:var(--text-dim);" onclick="doLogout()">LOGOUT</span>
  </div>
</nav>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page active" id="page-dashboard">
  <div class="section-header">
    <div class="section-label">REAL-TIME MONITORING</div>
    <div class="section-title">Safety Dashboard</div>
  </div>

  <div class="metrics-grid">
    <div class="metric-card">
      <div class="metric-label">RISK SCORE</div>
      <div class="metric-value text-red" id="metricRisk">0.00</div>
      <div class="metric-sub">Current window</div>
      <div class="metric-trend trend-up" id="metricTrend">‚Äî</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">RISK LEVEL</div>
      <div class="metric-value" id="metricLevel">LOW</div>
      <div class="metric-sub" id="metricLevelSub">No immediate action</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">ACCIDENT PROBABILITY</div>
      <div class="metric-value text-yellow" id="metricProb">0.00%</div>
      <div class="metric-sub">Sigmoid model</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">ALERT STATUS</div>
      <div class="metric-value text-green" id="metricAlert">CLEAR</div>
      <div class="metric-sub" id="metricAlertSub">Threshold: 8.0</div>
    </div>
  </div>

  <div class="card mb-24">
    <div class="card-title">VIOLATION BREAKDOWN ‚Äî PATHWAY WINDOW</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div>
        <div class="risk-bar-label"><span>ü™ñ NO HELMET</span><span class="text-mono text-red" id="barHelmet">0</span></div>
        <div class="risk-bar-track"><div class="risk-bar-fill" id="barHelmetFill" style="width:0%;background:#FF2D2D;"></div></div>
      </div>
      <div>
        <div class="risk-bar-label"><span>ü¶∫ NO VEST</span><span class="text-mono text-yellow" id="barVest">0</span></div>
        <div class="risk-bar-track"><div class="risk-bar-fill" id="barVestFill" style="width:0%;background:#FFD600;"></div></div>
      </div>
      <div>
        <div class="risk-bar-label"><span>üî• FIRE / SMOKE</span><span class="text-mono text-red" id="barFire">0</span></div>
        <div class="risk-bar-track"><div class="risk-bar-fill" id="barFireFill" style="width:0%;background:#FF6B2D;"></div></div>
      </div>
      <div>
        <div class="risk-bar-label"><span>‚õî INTRUSION</span><span class="text-mono" style="color:#A855F7" id="barIntrusion">0</span></div>
        <div class="risk-bar-track"><div class="risk-bar-fill" id="barIntrusionFill" style="width:0%;background:#A855F7;"></div></div>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card">
      <div class="flex justify-between align-center mb-16">
        <div class="card-title" style="margin-bottom:0;">LIVE EVENTS STREAM</div>
        <div id="eventCount" class="tag tag-green">0 EVENTS</div>
      </div>
      <div class="events-list" id="eventsList">
        <div class="empty-state">
          <div class="empty-state-icon">üì°</div>
          <div class="empty-state-title">Waiting for events...</div>
          <div class="empty-state-sub">Events will appear as they are detected</div>
        </div>
      </div>
    </div>

    <div class="pathway-panel">
      <div class="pathway-label">
        <div class="pulse-dot" style="background:var(--green);"></div>
        PATHWAY STREAM ENGINE
      </div>
      <div class="card-title" style="margin-bottom:8px;">SLIDING WINDOW: 10s / HOP: 2s</div>
      <div class="pathway-stream" id="pathwayMini">
        <div class="pathway-line"><span class="pathway-ts">[STARTUP]</span> <span style="color:var(--green)">Pathway pw.run() initializing...</span></div>
        <div class="pathway-line"><span class="pathway-ts">[PATHWAY]</span> <span style="color:var(--green)">EventSubject.run() started ‚Äî stream is live.</span></div>
        <div class="pathway-line"><span class="pathway-ts">[STARTUP]</span> Sliding window: 10s duration, 2s hop</div>
        <div class="pathway-line"><span class="pathway-ts">[STARTUP]</span> Aggregating: risk_score, helmet_count, vest_count, fire_count, intrusion_count</div>
        <div class="pathway-line"><span class="pathway-ts">[PATHWAY]</span> Behavior: delay=2s, cutoff=5s</div>
      </div>
      <div class="separator" style="margin:12px 0;"></div>
      <div class="card-title" style="margin-bottom:8px;">MITIGATION ADVICE</div>
      <div id="mitigationText" style="font-size:13px;color:var(--text-dim);line-height:1.6;">
        ‚úÖ No immediate action required. Continue standard monitoring.
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê AI ANALYST PANEL ‚Äî updated with RAG awareness ‚ïê‚ïê -->
  <div class="card mt-24" style="border-color:rgba(0,255,148,.25);background:linear-gradient(135deg,rgba(0,255,148,.03),var(--surface));">

    <!-- Header row -->
    <div class="flex justify-between align-center mb-16">
      <div>
        <div class="card-title" style="margin-bottom:4px;color:var(--green);" id="aiPanelTitle">
          ü§ñ AI SAFETY ANALYST ‚Äî PATHWAY LLM xPack + RAG
        </div>
        <div style="font-size:12px;color:var(--text-dim);">
          Real-time analysis using Pathway's live DocumentStore + LLM xPack
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div id="aiEmailBadge" style="display:none;" class="tag tag-red">üìß EMAIL SENT</div>
        <div id="aiRagBadge" style="display:none;" class="tag tag-green">üîç RAG ACTIVE</div>
      </div>
    </div>

    <!-- RAG pipeline status row ‚Äî NEW -->
    <div class="rag-status-row" id="ragStatusRow">
      <div class="rag-dot pending" id="ragDot"></div>
      <span id="ragStatusText" style="color:var(--text-dim);">Checking Pathway RAG pipeline status...</span>
      <span style="margin-left:auto;color:var(--text-dim);" id="ragModelText"></span>
    </div>

    <!-- AI report box -->
    <div id="aiExplainBox" style="display:none;margin-bottom:16px;padding:20px;background:var(--surface2);border-radius:8px;border-left:3px solid var(--green);">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <div style="font-family:var(--font-mono);font-size:10px;color:var(--green);letter-spacing:2px;">AI REPORT</div>
        <!-- RAG source badge shown inline in report ‚Äî NEW -->
        <div id="aiReportSourceBadge" style="display:none;" class="tag tag-green" style="font-size:9px;">üîç RAG-POWERED</div>
      </div>
      <div style="font-size:14px;line-height:1.8;color:var(--text);" id="aiExplainText"></div>
      <!-- Retrieved docs indicator ‚Äî NEW -->
      <div id="aiRagContextRow" style="display:none;margin-top:12px;padding:10px 12px;background:rgba(0,255,148,.05);border:1px solid rgba(0,255,148,.15);border-radius:6px;">
        <div style="font-family:var(--font-mono);font-size:10px;color:var(--green);letter-spacing:1px;margin-bottom:4px;">üìÑ RETRIEVED FROM SAFETY RULEBOOK (DocumentStore)</div>
        <div style="font-size:11px;color:var(--text-dim);" id="aiRagContextText">OSHA rules retrieved and injected into prompt via Pathway live index.</div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:12px;padding-top:10px;border-top:1px solid var(--border);">
        <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-dim);">
          Risk: <span id="aiRiskScore" style="color:var(--red);">‚Äî</span> | Level: <span id="aiRiskLevel">‚Äî</span>
        </div>
        <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-dim);" id="aiGeneratedAt">‚Äî</div>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="flex gap-8">
      <button class="btn btn-green" style="flex:1;" id="aiExplainBtn" onclick="getAIExplanation()">
        ü§ñ GET AI SAFETY REPORT
      </button>
      <button class="btn btn-ghost" onclick="getAICached()" title="Load last cached report">CACHED</button>
      <button class="btn btn-ghost" onclick="checkAIStatus()" title="Refresh RAG pipeline status">‚ü≥ RAG STATUS</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DETECTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-detection">
  <div class="section-header">
    <div class="section-label">AI-POWERED ANALYSIS</div>
    <div class="section-title">Safety Detection</div>
  </div>

  <div class="detect-grid">
    <div style="display:flex;flex-direction:column;gap:16px;">

      <!-- Image Upload -->
      <div class="card">
        <div class="flex justify-between align-center mb-16">
          <div class="card-title" style="margin-bottom:0;">IMAGE DETECTION</div>
          <div class="tag tag-green">YOLO MODEL</div>
        </div>
        <div class="upload-zone" id="imageDropZone">
          <input type="file" id="imageFile" accept="image/*" onchange="handleImageSelect(event)">
          <div class="upload-icon">üñºÔ∏è</div>
          <div class="upload-title">Drop Image or Click</div>
          <div class="upload-sub">Upload workplace image for safety analysis</div>
          <div class="upload-formats">
            <span class="tag tag-red">JPG</span>
            <span class="tag tag-red">PNG</span>
            <span class="tag tag-red">WEBP</span>
            <span class="tag tag-red">BMP</span>
          </div>
        </div>
        <div id="imagePreviewWrap" class="upload-preview" style="display:none;"></div>
        <div class="flex gap-8 mt-16">
          <button class="btn btn-red" style="flex:1;" onclick="detectImage()">
            <span id="imgBtnText">ANALYZE IMAGE</span>
          </button>
          <button class="btn btn-ghost" onclick="clearImage()">CLEAR</button>
        </div>
      </div>

      <!-- Video Upload -->
      <div class="card">
        <div class="flex justify-between align-center mb-16">
          <div class="card-title" style="margin-bottom:0;">VIDEO DETECTION</div>
          <div class="tag tag-yellow">FRAME SAMPLING</div>
        </div>
        <div class="upload-zone" id="videoDropZone">
          <input type="file" id="videoFile" accept="video/*" onchange="handleVideoSelect(event)">
          <div class="upload-icon">üé¨</div>
          <div class="upload-title">Drop Video or Click</div>
          <div class="upload-sub">Sampled every 5 frames for efficiency</div>
          <div class="upload-formats">
            <span class="tag tag-yellow">MP4</span>
            <span class="tag tag-yellow">AVI</span>
            <span class="tag tag-yellow">MOV</span>
            <span class="tag tag-yellow">MKV</span>
          </div>
        </div>
        <div id="videoPreviewWrap" class="upload-preview" style="display:none;"></div>
        <div id="videoProgressWrap" style="display:none;margin-top:12px;">
          <div class="risk-bar-label"><span>Processing...</span><span class="text-mono" id="videoProgressPct">0%</span></div>
          <div class="risk-bar-track"><div class="risk-bar-fill" id="videoProgressFill" style="width:0%;background:var(--yellow);"></div></div>
        </div>
        <div class="flex gap-8 mt-16">
          <button class="btn btn-red" style="flex:1;" onclick="detectVideo()">
            <span id="vidBtnText">ANALYZE VIDEO</span>
          </button>
          <button class="btn btn-ghost" onclick="clearVideo()">CLEAR</button>
        </div>
      </div>

      <!-- Live Camera -->
      <div class="card">
        <div class="flex justify-between align-center mb-16">
          <div class="card-title" style="margin-bottom:0;">LIVE CAMERA</div>
          <div class="tag tag-red" id="liveCamTag" style="display:none;">‚óè RECORDING</div>
        </div>
        <div class="live-cam-feed-wrap" id="liveCamWrap">
          <video id="liveCamFeed" autoplay playsinline muted></video>
          <canvas id="liveCamCanvas"></canvas>
          <div class="cam-snap-overlay" id="camSnapOverlay"></div>
          <div class="cam-overlay-badge" id="camLiveBadge">
            <div class="cam-overlay-dot"></div>
            LIVE
          </div>
          <div class="live-cam-placeholder" id="liveCamPlaceholder">
            <div class="icon">üì∑</div>
            <div style="font-family:var(--font-mono);font-size:12px;color:var(--text-dim);letter-spacing:1px;">CAMERA INACTIVE</div>
          </div>
        </div>
        <div id="liveCamStatusText" style="font-family:var(--font-mono);font-size:10px;color:var(--text-dim);margin-top:8px;margin-bottom:12px;letter-spacing:.5px;">
          Start camera to begin real-time YOLO detection
        </div>
        <div class="flex gap-8">
          <button class="btn btn-red" style="flex:1;" id="liveCamBtn" onclick="toggleLiveCamera()">
            START CAMERA
          </button>
          <button class="btn btn-ghost" id="snapBtn" onclick="snapAndAnalyze()" disabled>
            SNAP NOW
          </button>
        </div>
      </div>

      <!-- Manual Event Push -->
      <div class="card">
        <div class="card-title">MANUAL EVENT PUSH (PATHWAY)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
          <div>
            <div class="auth-label" style="margin-bottom:6px;">VIOLATION TYPE</div>
            <div class="select-wrap">
              <select class="auth-input" id="manualViolation">
                <option value="no_helmet">No Helmet</option>
                <option value="no_vest">No Vest</option>
                <option value="fire">Fire</option>
                <option value="smoke">Smoke</option>
                <option value="restricted_zone">Restricted Zone</option>
              </select>
            </div>
          </div>
          <div>
            <div class="auth-label" style="margin-bottom:6px;">ZONE</div>
            <div class="select-wrap">
              <select class="auth-input" id="manualZone">
                <option value="zone_a">Zone A (1.0x)</option>
                <option value="zone_b">Zone B (1.5x)</option>
                <option value="zone_c">Zone C (2.0x)</option>
                <option value="zone_d">Zone D (3.0x)</option>
              </select>
            </div>
          </div>
          <div>
            <div class="auth-label" style="margin-bottom:6px;">CONFIDENCE</div>
            <input class="auth-input" type="number" id="manualConf" value="0.85" min="0" max="1" step="0.01">
          </div>
          <div>
            <div class="auth-label" style="margin-bottom:6px;">CAMERA ID</div>
            <input class="auth-input" type="text" id="manualCam" value="manual_push">
          </div>
        </div>
        <button class="btn btn-green full-width" onclick="pushManualEvent()">‚ö° PUSH TO PATHWAY STREAM</button>
      </div>
    </div>

    <!-- RIGHT COLUMN: results -->
    <div>
      <div class="card" style="height:100%;">
        <div class="flex justify-between align-center mb-16">
          <div class="card-title" style="margin-bottom:0;">ANALYSIS RESULTS</div>
          <div id="resultBadge" class="tag tag-green">READY</div>
        </div>

        <div id="noResult" class="no-result">
          <div class="no-result-icon">üîç</div>
          <div style="font-family:var(--font-head);font-size:18px;font-weight:700;color:var(--text-dim);margin-bottom:8px;">No Analysis Yet</div>
          <div class="no-result-text">Upload an image, video, or use Live Camera</div>
        </div>

        <div id="resultContent" style="display:none;flex-direction:column;gap:16px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div class="pw-metric" style="border-color:var(--border);">
              <div class="pw-metric-title" style="color:var(--text-dim);">RISK SCORE</div>
              <div class="pw-metric-val" id="resultRiskScore" style="color:var(--red);">0.00</div>
              <div id="resultRiskBadge" class="tag tag-green mt-16" style="margin-top:8px;">LOW RISK</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <div class="pw-metric" style="border-color:var(--border);flex:1;">
                <div class="pw-metric-title" style="color:var(--text-dim);">VIOLATIONS</div>
                <div class="pw-metric-val" id="resultViolationCount">0</div>
              </div>
              <div class="pw-metric" style="border-color:var(--border);flex:1;">
                <div class="pw-metric-title" style="color:var(--text-dim);">FRAMES</div>
                <div class="pw-metric-val" id="resultFrameCount">‚Äî</div>
              </div>
            </div>
          </div>

          <div id="annotatedImageWrap" style="display:none;">
            <div class="card-title">ANNOTATED DETECTION IMAGE</div>
            <div style="position:relative;border-radius:6px;overflow:hidden;background:#000;">
              <img id="annotatedImage" src="" alt="Annotated" style="width:100%;border-radius:6px;max-height:320px;object-fit:contain;">
              <div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.7);padding:4px 10px;border-radius:4px;font-family:var(--font-mono);font-size:10px;color:var(--green);">SURAKSHA AI ANNOTATED</div>
            </div>
          </div>

          <div>
            <div class="card-title">DETECTED VIOLATIONS</div>
            <div class="violations-list" id="violationsList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEADERBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-leaderboard">
  <div class="section-header">
    <div class="section-label">SAFETY RANKINGS</div>
    <div class="section-title">Zone Leaderboard</div>
  </div>

  <div class="my-rank-card">
    <div class="my-avatar" id="myAvatar">A</div>
    <div class="my-info">
      <div class="my-name" id="myName">Loading...</div>
      <div class="my-sub" id="myRole">‚Äî</div>
    </div>
    <div class="my-points">
      <div class="my-points-num" id="myPoints">‚Äî</div>
      <div class="my-points-label">SAFETY SCORE</div>
    </div>
  </div>

  <div class="card mb-24">
    <div class="flex align-center gap-8 mb-24" style="margin-bottom:20px;">
      <span style="font-size:20px;">‚öîÔ∏è</span>
      <div class="card-title" style="margin-bottom:0;">ZONE SAFETY BATTLE</div>
    </div>
    <div class="zone-battle" id="zoneBattle">
      <div class="empty-state" style="grid-column:span 2;">
        <div class="empty-state-icon">‚è≥</div>
        <div class="empty-state-title">Loading zones...</div>
      </div>
    </div>
  </div>

  <div class="card-title mb-16">TOP 3 ZONES</div>
  <div class="podium" id="podium">
    <div class="empty-state" style="grid-column:span 3;">
      <div class="empty-state-icon">‚è≥</div>
      <div class="empty-state-title">Loading leaderboard...</div>
    </div>
  </div>

  <div class="lb-table mt-24">
    <div class="lb-table-header">
      <div>RANK</div>
      <div>ZONE</div>
      <div>VIOLATIONS</div>
      <div>RISK SCORE</div>
      <div>VELOCITY</div>
      <div>STATUS</div>
    </div>
    <div id="lbTableBody">
      <div class="empty-state">
        <div class="empty-state-icon">‚è≥</div>
        <div class="empty-state-title">Loading data...</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PATHWAY LIVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-pathway">
  <div class="section-header">
    <div class="section-label">STREAMING DATA ENGINE</div>
    <div class="section-title">Pathway Live View</div>
  </div>

  <div class="card mb-24" style="border-color:rgba(0,255,148,.2);background:rgba(0,255,148,.03);">
    <div class="flex align-center gap-16 mb-16">
      <div class="pulse-dot" style="width:12px;height:12px;background:var(--green);"></div>
      <div class="card-title" style="margin-bottom:0;color:var(--green);">HOW PATHWAY IS USED IN SURAKSHA AI</div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;">
      <div style="padding:16px;background:var(--surface2);border-radius:6px;border-top:2px solid var(--green);">
        <div style="font-family:var(--font-mono);font-size:10px;color:var(--green);margin-bottom:8px;">STEP 1 ‚Äî INGEST</div>
        <div style="font-size:12px;color:var(--text-dim);">Events pushed via <code style="color:var(--yellow)">EventSubject.push()</code> from YOLO detections, simulator, and manual API calls</div>
      </div>
      <div style="padding:16px;background:var(--surface2);border-radius:6px;border-top:2px solid var(--yellow);">
        <div style="font-family:var(--font-mono);font-size:10px;color:var(--yellow);margin-bottom:8px;">STEP 2 ‚Äî WINDOW</div>
        <div style="font-size:12px;color:var(--text-dim);">Sliding window (10s duration, 2s hop) groups events. Common behavior: delay=2s, cutoff=5s</div>
      </div>
      <div style="padding:16px;background:var(--surface2);border-radius:6px;border-top:2px solid var(--red);">
        <div style="font-family:var(--font-mono);font-size:10px;color:var(--red);margin-bottom:8px;">STEP 3 ‚Äî AGGREGATE</div>
        <div style="font-size:12px;color:var(--text-dim);">Sum weighted risk scores by violation type √ó zone multiplier. Count helmets, vests, fire, intrusions</div>
      </div>
      <div style="padding:16px;background:var(--surface2);border-radius:6px;border-top:2px solid #A855F7;">
        <div style="font-family:var(--font-mono);font-size:10px;color:#A855F7;margin-bottom:8px;">STEP 4 ‚Äî OBSERVE</div>
        <div style="font-size:12px;color:var(--text-dim);"><code style="color:var(--yellow)">on_change()</code> callback updates global state. Frontend polls /analytics every 2s to visualize</div>
      </div>
    </div>
  </div>

  <!-- NEW ‚Äî RAG pipeline explanation card -->
  <div class="card mb-24" style="border-color:rgba(0,255,148,.2);background:rgba(0,255,148,.02);">
    <div class="flex align-center gap-16 mb-16">
      <div class="pulse-dot" style="width:12px;height:12px;background:var(--green);"></div>
      <div class="card-title" style="margin-bottom:0;color:var(--green);">PATHWAY LLM xPACK ‚Äî RAG PIPELINE</div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;">
      <div style="padding:16px;background:var(--surface2);border-radius:6px;border-top:2px solid var(--green);">
        <div style="font-family:var(--font-mono);font-size:10px;color:var(--green);margin-bottom:8px;">STEP A ‚Äî DOCS</div>
        <div style="font-size:12px;color:var(--text-dim);"><code style="color:var(--yellow)">pw.io.fs.read()</code> streams <code style="color:var(--yellow)">./safety_docs/</code> ‚Äî auto-updates when OSHA rule files change</div>
      </div>
      <div style="padding:16px;background:var(--surface2);border-radius:6px;border-top:2px solid var(--yellow);">
        <div style="font-family:var(--font-mono);font-size:10px;color:var(--yellow);margin-bottom:8px;">STEP B ‚Äî INDEX</div>
        <div style="font-size:12px;color:var(--text-dim);"><code style="color:var(--yellow)">DocumentStore</code> maintains live BM25 + KNN hybrid index via <code style="color:var(--yellow)">BruteForceKnnFactory</code></div>
      </div>
      <div style="padding:16px;background:var(--surface2);border-radius:6px;border-top:2px solid var(--red);">
        <div style="font-family:var(--font-mono);font-size:10px;color:var(--red);margin-bottom:8px;">STEP C ‚Äî RETRIEVE</div>
        <div style="font-size:12px;color:var(--text-dim);"><code style="color:var(--yellow)">doc_store.retrieve(query, k=3)</code> fetches top-3 relevant OSHA rule chunks for the violation context</div>
      </div>
      <div style="padding:16px;background:var(--surface2);border-radius:6px;border-top:2px solid #A855F7;">
        <div style="font-family:var(--font-mono);font-size:10px;color:#A855F7;margin-bottom:8px;">STEP D ‚Äî GENERATE</div>
        <div style="font-size:12px;color:var(--text-dim);"><code style="color:var(--yellow)">LiteLLMChat</code> via OpenRouter generates a grounded safety report citing retrieved rules</div>
      </div>
    </div>
    <div style="margin-top:16px;padding:12px 16px;background:var(--surface2);border-radius:6px;display:flex;align-items:center;gap:12px;">
      <div class="rag-dot off" id="ragDotPathwayPage"></div>
      <span style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim);" id="ragStatusPathwayPage">Checking RAG pipeline...</span>
    </div>
  </div>

  <div class="pathway-full">
    <div>
      <div class="card-title mb-16">PATHWAY ENGINE TERMINAL</div>
      <div class="terminal" id="pathwayTerminal">
        <div class="terminal-header">SURAKSHA AI ‚Äî PATHWAY STREAM ENGINE v1.0.0</div>
        <div class="t-line"><span class="t-green">[PATHWAY]</span> <span class="t-white">pw.run() starting...</span></div>
        <div class="t-line"><span class="t-green">[PATHWAY]</span> <span class="t-white">EventSubject.run() started ‚Äî stream is live.</span></div>
        <div class="t-line"><span class="t-green">[STARTUP]</span> <span class="t-white">Pathway risk engine started.</span></div>
        <div class="t-line"><span class="t-yellow">[CONFIG]</span> <span class="t-white">Window: 10s | Hop: 2s | Alert threshold: 8.0</span></div>
        <div class="t-line"><span class="t-yellow">[CONFIG]</span> <span class="t-white">Weights: fire=3.0 smoke=2.5 restricted=1.5 helmet=1.2 vest=1.0</span></div>
        <div class="t-line"><span class="t-yellow">[CONFIG]</span> <span class="t-white">Zone multipliers: A=1.0 B=1.5 C=2.0 D=3.0</span></div>
        <div class="t-line"><span class="t-green">[RAG]</span> <span class="t-white">LLM xPack initialising...</span></div>
        <div class="t-line"><span class="t-green">[RAG]</span> <span class="t-white">DocumentStore: streaming ./safety_docs/ (BM25 + KNN)</span></div>
        <div class="t-line">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
      </div>
    </div>

    <div class="pathway-metrics">
      <div class="pw-metric" style="border-color:rgba(0,255,148,.3);">
        <div class="pw-metric-title">CURRENT WINDOW RISK SCORE</div>
        <div class="pw-metric-val text-red" id="pwRiskScore">0.00</div>
        <div class="pw-metric-desc">Weighted sum over 10-second sliding window</div>
        <div class="event-chart" id="riskChart"></div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div class="pw-metric">
          <div class="pw-metric-title">VELOCITY</div>
          <div class="pw-metric-val" id="pwVelocity">+0.00</div>
          <div class="pw-metric-desc">Risk change rate</div>
        </div>
        <div class="pw-metric">
          <div class="pw-metric-title">PREDICTED RISK</div>
          <div class="pw-metric-val text-yellow" id="pwPredicted">0.00</div>
          <div class="pw-metric-desc">2-step lookahead</div>
        </div>
        <div class="pw-metric">
          <div class="pw-metric-title">GROWTH RATE</div>
          <div class="pw-metric-val" id="pwGrowth">0%</div>
          <div class="pw-metric-desc">Vs. previous window</div>
        </div>
        <div class="pw-metric">
          <div class="pw-metric-title">ACCIDENT PROB.</div>
          <div class="pw-metric-val text-red" id="pwProb">0.00%</div>
          <div class="pw-metric-desc">Sigmoid(score / 5)</div>
        </div>
      </div>

      <div class="pw-metric" style="border-color:rgba(255,45,45,.3);">
        <div class="pw-metric-title">ACTIVE ALERT</div>
        <div class="pw-metric-val text-green" id="pwAlert">‚úÖ CLEAR</div>
        <div class="pw-metric-desc" id="pwMitigation">‚úÖ No immediate action required. Continue standard monitoring.</div>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_BASE = 'http://localhost:8000';
let authToken = localStorage.getItem('surakshaToken') || null;
let currentUser = JSON.parse(localStorage.getItem('surakshaUser') || 'null');
let pollingInterval = null;
let riskHistory = Array(20).fill(0);
let totalEvents = 0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function apiFetch(path, opts) {
  opts = opts || {};
  var headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
  if (authToken) headers['Authorization'] = 'Bearer ' + authToken;
  var res = await fetch(API_BASE + path, Object.assign({}, opts, { headers: headers }));
  if (res.status === 401) { doLogout(); throw new Error('Unauthorized'); }
  return res;
}

async function doLogin() {
  var email = document.getElementById('loginEmail').value;
  var password = document.getElementById('loginPassword').value;
  var spinner = document.getElementById('loginSpinner');
  var error = document.getElementById('loginError');
  spinner.style.display = 'block';
  error.style.display = 'none';
  try {
    var res = await fetch(API_BASE + '/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email, password: password })
    });
    if (!res.ok) throw new Error('Invalid credentials');
    var data = await res.json();
    authToken = data.access_token;
    localStorage.setItem('surakshaToken', authToken);
    var meRes = await fetch(API_BASE + '/me', { headers: { Authorization: 'Bearer ' + authToken } });
    if (meRes.ok) {
      currentUser = await meRes.json();
      localStorage.setItem('surakshaUser', JSON.stringify(currentUser));
    }
    document.getElementById('authOverlay').style.display = 'none';
    initDashboard();
    toast('Signed in successfully', 'success');
  } catch(e) {
    error.style.display = 'block';
  } finally {
    spinner.style.display = 'none';
  }
}

async function doRegister() {
  var name = document.getElementById('regName').value;
  var email = document.getElementById('regEmail').value;
  var password = document.getElementById('regPassword').value;
  var role = document.getElementById('regRole').value;
  var spinner = document.getElementById('regSpinner');
  var error = document.getElementById('regError');
  spinner.style.display = 'block';
  error.style.display = 'none';
  try {
    var res = await fetch(API_BASE + '/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name, email: email, password: password, role: role })
    });
    if (!res.ok) {
      var d = await res.json();
      throw new Error(d.detail || 'Registration failed');
    }
    toast('Account created! Please sign in.', 'success');
    showLogin();
    document.getElementById('loginEmail').value = email;
  } catch(e) {
    error.textContent = e.message;
    error.style.display = 'block';
  } finally {
    spinner.style.display = 'none';
  }
}

function doLogout() {
  stopLiveCamera();
  authToken = null;
  currentUser = null;
  localStorage.removeItem('surakshaToken');
  localStorage.removeItem('surakshaUser');
  if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; }
  if (window._lbInterval) { clearInterval(window._lbInterval); window._lbInterval = null; }
  document.getElementById('authOverlay').style.display = 'flex';
}

function showRegister() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('registerForm').style.display = 'block';
}
function showLogin() {
  document.getElementById('registerForm').style.display = 'none';
  document.getElementById('loginForm').style.display = 'block';
}

if (authToken) {
  document.getElementById('authOverlay').style.display = 'none';
  initDashboard();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(id, btn) {
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.nav-btn').forEach(function(b) { b.classList.remove('active'); });
  document.getElementById('page-' + id).classList.add('active');
  if (btn) btn.classList.add('active');
  if (id === 'leaderboard') {
    loadLeaderboard();
    if (window._lbInterval) clearInterval(window._lbInterval);
    window._lbInterval = setInterval(loadLeaderboard, 3000);
  } else {
    if (window._lbInterval) { clearInterval(window._lbInterval); window._lbInterval = null; }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD POLLING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initDashboard() {
  if (currentUser) {
    document.getElementById('myName').textContent = currentUser.name || 'User';
    document.getElementById('myRole').textContent = (currentUser.role || '').toUpperCase() || '‚Äî';
    document.getElementById('myAvatar').textContent = (currentUser.name || 'U').charAt(0).toUpperCase();
    document.getElementById('myPoints').textContent = Math.floor(Math.random() * 5000 + 1000);
  }
  pollAnalytics();
  pollingInterval = setInterval(pollAnalytics, 2000);
  initRiskChart();
  // Check RAG status on load
  checkAIStatus();
}

async function pollAnalytics() {
  if (!authToken) return;
  try {
    var res = await apiFetch('/analytics');
    if (!res.ok) return;
    var d = await res.json();
    updateDashboard(d);
    updatePathway(d);
  } catch(e) { /* silent */ }
}

function updateDashboard(d) {
  var riskScore = parseFloat(d.risk_score || 0);
  var level = d.risk_level || 'LOW';
  var prob = parseFloat(d.accident_probability || 0);
  var alert = d.alert_triggered || false;

  document.getElementById('metricRisk').textContent = riskScore.toFixed(2);
  document.getElementById('metricLevel').textContent = level;
  document.getElementById('metricLevel').style.color = level === 'CRITICAL' ? 'var(--red)' : level === 'MEDIUM' ? 'var(--yellow)' : 'var(--green)';
  document.getElementById('metricLevelSub').textContent = level === 'CRITICAL' ? 'Immediate action required' : level === 'MEDIUM' ? 'Review live feed' : 'No immediate action';
  document.getElementById('metricProb').textContent = (prob * 100).toFixed(2) + '%';
  document.getElementById('metricAlert').textContent = alert ? '‚ö†Ô∏è ALERT' : '‚úÖ CLEAR';
  document.getElementById('metricAlert').style.color = alert ? 'var(--red)' : 'var(--green)';
  document.getElementById('metricAlertSub').textContent = alert ? 'Score > threshold 8.0' : 'Threshold: 8.0';

  var vel = parseFloat(d.velocity || 0);
  document.getElementById('metricTrend').textContent = vel > 0 ? '‚Üë +' + vel.toFixed(2) : vel < 0 ? '‚Üì ' + vel.toFixed(2) : '‚Äî';
  document.getElementById('metricTrend').className = 'metric-trend ' + (vel > 0 ? 'trend-up' : 'trend-down');

  var helmet = parseInt(d.helmet_count || 0);
  var vest = parseInt(d.vest_count || 0);
  var fire = parseInt(d.fire_count || 0);
  var intrusion = parseInt(d.intrusion_count || 0);
  var maxVal = Math.max(helmet, vest, fire, intrusion, 1);
  document.getElementById('barHelmet').textContent = helmet;
  document.getElementById('barVest').textContent = vest;
  document.getElementById('barFire').textContent = fire;
  document.getElementById('barIntrusion').textContent = intrusion;
  document.getElementById('barHelmetFill').style.width = (helmet / maxVal * 100) + '%';
  document.getElementById('barVestFill').style.width = (vest / maxVal * 100) + '%';
  document.getElementById('barFireFill').style.width = (fire / maxVal * 100) + '%';
  document.getElementById('barIntrusionFill').style.width = (intrusion / maxVal * 100) + '%';

  if (riskScore > 0) addEventToStream(d);
  document.getElementById('mitigationText').textContent = d.mitigation_text || '‚úÖ No immediate action required.';
}

var lastRisk = 0;

function addEventToStream(d) {
  var riskScore = parseFloat(d.risk_score || 0);
  if (Math.abs(riskScore - lastRisk) < 0.01) return;
  lastRisk = riskScore;
  totalEvents++;

  var el = document.querySelector('#eventsList .empty-state');
  if (el) el.remove();

  var level = d.risk_level;
  var item = document.createElement('div');
  item.className = 'event-item ' + level.toLowerCase();
  var violations = [];
  if (d.helmet_count > 0) violations.push(d.helmet_count + ' no-helmet');
  if (d.vest_count > 0) violations.push(d.vest_count + ' no-vest');
  if (d.fire_count > 0) violations.push(d.fire_count + ' fire/smoke');
  if (d.intrusion_count > 0) violations.push(d.intrusion_count + ' intrusion');
  var text = violations.length ? violations.join(', ') : 'Safety event detected';
  var now = new Date().toLocaleTimeString();
  item.innerHTML =
    '<div class="event-dot ' + level.toLowerCase() + '"></div>' +
    '<div class="event-text">' + text + '</div>' +
    '<div class="event-zone">' + level + '</div>' +
    '<div class="event-time">' + now + '</div>';
  var list = document.getElementById('eventsList');
  list.insertBefore(item, list.firstChild);
  while (list.children.length > 20) list.removeChild(list.lastChild);
  document.getElementById('eventCount').textContent = totalEvents + ' EVENTS';

  addPathwayLine(d, riskScore);
}

function addPathwayLine(d, score) {
  var mini = document.getElementById('pathwayMini');
  var ts = new Date().toISOString().substr(11, 8);
  var line = document.createElement('div');
  line.className = 'pathway-line new';
  line.innerHTML =
    '<span class="pathway-ts">[' + ts + ']</span> ' +
    '<span class="pathway-event">[ON_CHANGE]</span> ' +
    '<span class="pathway-score">score=' + score.toFixed(2) + '</span>' +
    ' | level=' + d.risk_level +
    ' | vel=' + parseFloat(d.velocity || 0).toFixed(2);
  mini.appendChild(line);
  mini.scrollTop = mini.scrollHeight;
  if (mini.children.length > 50) mini.removeChild(mini.firstChild);
}

function updatePathway(d) {
  var score = parseFloat(d.risk_score || 0);
  var vel = parseFloat(d.velocity || 0);
  document.getElementById('pwRiskScore').textContent = score.toFixed(2);
  document.getElementById('pwVelocity').textContent = vel >= 0 ? '+' + vel.toFixed(4) : vel.toFixed(4);
  document.getElementById('pwVelocity').style.color = vel > 0 ? 'var(--red)' : 'var(--green)';
  document.getElementById('pwPredicted').textContent = parseFloat(d.predicted_risk || 0).toFixed(2);
  document.getElementById('pwGrowth').textContent = parseFloat(d.growth_rate || 0).toFixed(2) + '%';
  document.getElementById('pwProb').textContent = (parseFloat(d.accident_probability || 0) * 100).toFixed(2) + '%';
  var alert = d.alert_triggered;
  document.getElementById('pwAlert').textContent = alert ? 'üö® ALERT TRIGGERED' : '‚úÖ CLEAR';
  document.getElementById('pwAlert').style.color = alert ? 'var(--red)' : 'var(--green)';
  document.getElementById('pwMitigation').textContent = d.mitigation_text || '';

  var term = document.getElementById('pathwayTerminal');
  if (Math.abs(score - lastRisk) > 0.01) {
    var ts = new Date().toISOString().substr(11, 8);
    var line = document.createElement('div');
    line.className = 't-line new-entry';
    var scoreClass = score > 10 ? 'red' : score > 5 ? 'yellow' : 'green';
    line.innerHTML =
      '<span class="t-green">[' + ts + ']</span> ' +
      '<span class="t-white">[RISK ENGINE]</span> ' +
      'score=<span class="t-' + scoreClass + '">' + score.toFixed(2) + '</span> | ' +
      'level=<span class="t-white">' + d.risk_level + '</span> | ' +
      'vel=<span class="t-' + (vel > 0 ? 'red' : 'green') + '">' + (vel >= 0 ? '+' : '') + vel.toFixed(2) + '</span> | ' +
      'alert=<span class="t-' + (alert ? 'red' : 'green') + '">' + (alert ? 'üö® YES' : '‚úÖ NO') + '</span>';
    term.appendChild(line);
    term.scrollTop = term.scrollHeight;
    if (term.children.length > 60) term.removeChild(term.children[1]);
  }

  riskHistory.push(score);
  if (riskHistory.length > 20) riskHistory.shift();
  updateRiskChart();
}

function initRiskChart() {
  var chart = document.getElementById('riskChart');
  chart.innerHTML = '';
  for (var i = 0; i < 20; i++) {
    var bar = document.createElement('div');
    bar.className = 'chart-bar';
    bar.style.height = '2px';
    chart.appendChild(bar);
  }
}

function updateRiskChart() {
  var bars = document.querySelectorAll('#riskChart .chart-bar');
  var max = Math.max.apply(null, riskHistory.concat([1]));
  riskHistory.forEach(function(v, i) {
    if (bars[i]) bars[i].style.height = Math.max((v / max) * 72, 2) + 'px';
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RAG STATUS CHECK ‚Äî NEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function checkAIStatus() {
  if (!authToken) return;
  try {
    var res = await apiFetch('/ai/status');
    if (!res.ok) return;
    var d = await res.json();

    var dot = document.getElementById('ragDot');
    var statusText = document.getElementById('ragStatusText');
    var modelText = document.getElementById('ragModelText');
    var dot2 = document.getElementById('ragDotPathwayPage');
    var statusText2 = document.getElementById('ragStatusPathwayPage');

    if (d.rag_pipeline_ready) {
      // RAG fully live
      dot.className = 'rag-dot live';
      dot2.className = 'rag-dot live';
      statusText.textContent = '‚úÖ Pathway RAG pipeline LIVE ‚Äî DocumentStore indexing ' + (d.safety_docs_dir || './safety_docs');
      statusText.style.color = 'var(--green)';
      statusText2.textContent = '‚úÖ RAG pipeline LIVE ‚Äî BM25 + KNN index ready';
      statusText2.style.color = 'var(--green)';
      modelText.textContent = d.model || '';
      // Update panel title to show RAG active
      document.getElementById('aiPanelTitle').textContent = 'ü§ñ AI SAFETY ANALYST ‚Äî PATHWAY RAG ‚úÖ LIVE';
      // Add RAG terminal line
      addTerminalLine('RAG', '‚úÖ DocumentStore live ‚Äî safety_docs indexed via BM25+KNN', 'green');
    } else if (d.llm_ready) {
      // LLM ready but no RAG
      dot.className = 'rag-dot pending';
      dot2.className = 'rag-dot pending';
      statusText.textContent = '‚ö° Pathway LLM xPack ready ‚Äî RAG indexing in progress...';
      statusText.style.color = 'var(--yellow)';
      statusText2.textContent = '‚ö° LLM ready ‚Äî DocumentStore still indexing...';
      statusText2.style.color = 'var(--yellow)';
      modelText.textContent = d.model || '';
    } else {
      // Nothing ready
      dot.className = 'rag-dot pending';
      dot2.className = 'rag-dot pending';
      statusText.textContent = '‚ö° AI pipeline initialising ‚Äî LLM ready, RAG indexing...';
      statusText.style.color = 'var(--yellow)';
      statusText2.textContent = '‚ö†Ô∏è Pipeline offline';
      statusText2.style.color = 'var(--text-dim)';
    }
  } catch(e) {
    // Backend not reachable ‚Äî silent
  }
}

function addTerminalLine(tag, msg, color) {
  var term = document.getElementById('pathwayTerminal');
  if (!term) return;
  var ts = new Date().toISOString().substr(11, 8);
  var line = document.createElement('div');
  line.className = 't-line new-entry';
  line.innerHTML = '<span class="t-' + color + '">[' + ts + ']</span> <span class="t-' + color + '">[' + tag + ']</span> <span class="t-white">' + msg + '</span>';
  term.appendChild(line);
  term.scrollTop = term.scrollHeight;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEADERBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadLeaderboard() {
  try {
    var res = await apiFetch('/leaderboard');
    if (!res.ok) return;
    var data = await res.json();
    renderLeaderboard(data);
  } catch(e) { /* silent */ }
}

function renderLeaderboard(data) {
  if (!data || !data.length) return;
  var colors = ['var(--red)', 'var(--yellow)', 'var(--green)', '#A855F7'];
  var zoneBattle = document.getElementById('zoneBattle');
  zoneBattle.innerHTML = data.slice(0, 4).map(function(z, i) {
    var pct = Math.min((z.risk_score / 100) * 100, 100).toFixed(1);
    var alertText = z.alert ? 'üö® HIGH' : '‚úÖ OK';
    return '<div class="zone-card">' +
      '<div class="zone-name" style="color:' + colors[i % colors.length] + '">' + z.zone.toUpperCase() + '</div>' +
      '<div class="zone-progress"><div class="zone-progress-fill" style="width:' + pct + '%;background:' + colors[i % colors.length] + ';"></div></div>' +
      '<div class="zone-stats">' +
        '<span>Risk: ' + z.risk_score.toFixed(1) + '</span>' +
        '<span>Violations: ' + z.violation_count + '</span>' +
        '<span>' + alertText + '</span>' +
      '</div>' +
    '</div>';
  }).join('');

  var sorted = data.slice().sort(function(a, b) { return b.risk_score - a.risk_score; });
  var top3 = sorted.slice(0, 3);
  var podiumOrder = top3.length >= 2 ? [top3[1], top3[0], top3[2]].filter(Boolean) : top3;
  var classes = top3.length >= 2 ? ['second', 'first', 'third'] : ['first'];
  var medals = ['ü•à', 'ü•á', 'ü•â'];
  document.getElementById('podium').innerHTML = podiumOrder.map(function(z, i) {
    var rank = podiumOrder.length >= 2 ? (i === 1 ? 1 : i === 0 ? 2 : 3) : 1;
    return '<div class="podium-card ' + (classes[i] || '') + '">' +
      '<div class="podium-medal">' + medals[i] + '</div>' +
      '<div class="podium-rank">RANK #' + rank + '</div>' +
      '<div class="podium-name">' + z.zone.toUpperCase() + '</div>' +
      '<div class="podium-zone">' + z.violation_count + ' violations</div>' +
      '<div class="podium-score">' + z.risk_score.toFixed(1) + '</div>' +
      '<div class="podium-score-label">RISK SCORE</div>' +
    '</div>';
  }).join('');

  document.getElementById('lbTableBody').innerHTML = sorted.map(function(z, i) {
    return '<div class="lb-row">' +
      '<div class="lb-rank ' + (i < 3 ? 'top' : '') + '">' + (i < 3 ? ['ü•á','ü•à','ü•â'][i] : '#' + (i + 1)) + '</div>' +
      '<div><div class="lb-name">' + z.zone.toUpperCase() + '</div><div class="lb-zone">' + z.violation_count + ' incidents</div></div>' +
      '<div class="lb-scans text-mono">' + z.violation_count + '</div>' +
      '<div class="lb-points">' + z.risk_score.toFixed(2) + '</div>' +
      '<div class="lb-scans text-mono">' + z.velocity + '</div>' +
      '<div><div class="tag ' + (z.alert ? 'tag-red' : 'tag-green') + '">' + (z.alert ? 'HIGH' : 'OK') + '</div></div>' +
    '</div>';
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê IMAGE / VIDEO DETECTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var selectedImage = null;
var selectedVideo = null;

function handleImageSelect(e) {
  var file = e.target.files[0];
  if (!file) return;
  selectedImage = file;
  var url = URL.createObjectURL(file);
  var wrap = document.getElementById('imagePreviewWrap');
  wrap.style.display = 'block';
  wrap.innerHTML = '<img src="' + url + '" alt="Preview">';
}

function handleVideoSelect(e) {
  var file = e.target.files[0];
  if (!file) return;
  selectedVideo = file;
  var url = URL.createObjectURL(file);
  var wrap = document.getElementById('videoPreviewWrap');
  wrap.style.display = 'block';
  wrap.innerHTML = '<video src="' + url + '" controls></video>';
}

function clearImage() {
  selectedImage = null;
  document.getElementById('imageFile').value = '';
  document.getElementById('imagePreviewWrap').style.display = 'none';
  document.getElementById('imagePreviewWrap').innerHTML = '';
}

function clearVideo() {
  selectedVideo = null;
  document.getElementById('videoFile').value = '';
  document.getElementById('videoPreviewWrap').style.display = 'none';
  document.getElementById('videoPreviewWrap').innerHTML = '';
  document.getElementById('videoProgressWrap').style.display = 'none';
}

async function detectImage() {
  if (!selectedImage) { toast('Please select an image first', 'error'); return; }
  var btn = document.getElementById('imgBtnText');
  btn.textContent = 'ANALYZING...';
  var formData = new FormData();
  formData.append('file', selectedImage);
  try {
    var res = await fetch(API_BASE + '/detect/image', {
      method: 'POST',
      headers: { Authorization: 'Bearer ' + authToken },
      body: formData
    });
    if (!res.ok) throw new Error('Detection failed');
    var data = await res.json();
    showDetectionResult(data, 1);
    toast('Detection complete: ' + data.violations.length + ' violations found', data.violations.length > 0 ? 'error' : 'success');
  } catch(e) {
    toast('Detection failed. Is the backend running?', 'error');
    showDetectionResult({ violations: [], risk_score: 0, frame_count: 1 }, 1);
  } finally {
    btn.textContent = 'ANALYZE IMAGE';
  }
}

async function detectVideo() {
  if (!selectedVideo) { toast('Please select a video first', 'error'); return; }
  var btn = document.getElementById('vidBtnText');
  btn.textContent = 'PROCESSING...';
  document.getElementById('videoProgressWrap').style.display = 'block';

  var prog = 0;
  var interval = setInterval(function() {
    prog = Math.min(prog + Math.random() * 3, 90);
    document.getElementById('videoProgressFill').style.width = prog + '%';
    document.getElementById('videoProgressPct').textContent = prog.toFixed(0) + '%';
  }, 200);

  var formData = new FormData();
  formData.append('file', selectedVideo);
  try {
    var res = await fetch(API_BASE + '/detect/video', {
      method: 'POST',
      headers: { Authorization: 'Bearer ' + authToken },
      body: formData
    });
    if (!res.ok) throw new Error('Detection failed');
    var data = await res.json();
    clearInterval(interval);
    document.getElementById('videoProgressFill').style.width = '100%';
    document.getElementById('videoProgressPct').textContent = '100%';
    showDetectionResult(data, data.frame_count);
    toast('Video analyzed: ' + data.frame_count + ' frames, ' + data.violations.length + ' violations', 'success');
  } catch(e) {
    clearInterval(interval);
    toast('Video detection failed. Is the backend running?', 'error');
    showDetectionResult({ violations: [], risk_score: 0, frame_count: 0 }, 0);
  } finally {
    btn.textContent = 'ANALYZE VIDEO';
    setTimeout(function() { document.getElementById('videoProgressWrap').style.display = 'none'; }, 2000);
  }
}

function showDetectionResult(data, frames) {
  document.getElementById('noResult').style.display = 'none';
  var rc = document.getElementById('resultContent');
  rc.style.display = 'flex';

  var risk = parseFloat(data.risk_score || 0);
  var level = risk > 100 ? 'CRITICAL' : risk > 50 ? 'HIGH' : risk > 20 ? 'MEDIUM' : 'LOW';
  var colorClass = risk > 50 ? 'tag-red' : risk > 20 ? 'tag-yellow' : 'tag-green';
  var riskColor = risk > 50 ? 'var(--red)' : risk > 20 ? 'var(--yellow)' : 'var(--green)';

  document.getElementById('resultRiskScore').textContent = risk.toFixed(2);
  document.getElementById('resultRiskScore').style.color = riskColor;
  document.getElementById('resultBadge').textContent = level + ' RISK';
  document.getElementById('resultBadge').className = 'tag ' + colorClass;
  document.getElementById('resultRiskBadge').textContent = level + ' RISK';
  document.getElementById('resultRiskBadge').className = 'tag ' + colorClass;
  document.getElementById('resultViolationCount').textContent = (data.violations && data.violations.length) || 0;
  document.getElementById('resultFrameCount').textContent = frames === 1 ? 'IMAGE' : (frames || '‚Äî');

  if (data.annotated_image) {
    document.getElementById('annotatedImage').src = 'data:image/jpeg;base64,' + data.annotated_image;
    document.getElementById('annotatedImageWrap').style.display = 'block';
  } else {
    document.getElementById('annotatedImageWrap').style.display = 'none';
  }

  var icons = { no_helmet: 'ü™ñ', no_vest: 'ü¶∫', fire: 'üî•', smoke: 'üí®', restricted_zone: '‚õî', unknown: '‚ö†Ô∏è' };
  var list = document.getElementById('violationsList');

  if (!data.violations || !data.violations.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div class="empty-state-title">No Violations Detected</div></div>';
  } else {
    list.innerHTML = data.violations.map(function(v) {
      var conf = (v.confidence * 100).toFixed(1);
      var icon = icons[v.type] || '‚ö†Ô∏è';
      var bbox = (v.bbox || []).map(function(n) { return Math.round(n); }).join(', ');
      return '<div class="violation-item">' +
        '<div class="violation-icon">' + icon + '</div>' +
        '<div style="flex:1;">' +
          '<div class="violation-name">' + v.type.replace(/_/g, ' ').toUpperCase() + '</div>' +
          '<div style="font-size:11px;color:var(--text-dim);">Zone: ' + v.zone + ' | BBox: [' + bbox + ']</div>' +
          '<div class="confidence-bar"><div class="confidence-fill" style="width:' + conf + '%;"></div></div>' +
        '</div>' +
        '<div class="violation-conf">' + conf + '%</div>' +
      '</div>';
    }).join('');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI EXPLANATION ‚Äî updated for RAG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function getAIExplanation() {
  var btn = document.getElementById('aiExplainBtn');
  btn.textContent = 'ü§ñ ANALYZING WITH PATHWAY RAG...';
  btn.disabled = true;
  try {
    var res = await apiFetch('/ai/explain');
    if (!res.ok) throw new Error('AI request failed');
    var data = await res.json();
    renderAIReport(data);
    if (data.email_sent) {
      document.getElementById('aiEmailBadge').style.display = 'inline-block';
      toast('üìß Critical alert email sent to safety officer!', 'error');
    }
    if (data.rag_used) {
      toast('üîç RAG-powered report generated from live safety rulebook', 'success');
    } else {
      toast('AI safety report generated', 'success');
    }
  } catch(e) {
    toast('AI analysis failed ‚Äî check OPENROUTER_API_KEY in .env', 'error');
  } finally {
    btn.textContent = 'ü§ñ GET AI SAFETY REPORT';
    btn.disabled = false;
  }
}

async function getAICached() {
  try {
    var res = await apiFetch('/ai/cached');
    if (!res.ok) throw new Error();
    var data = await res.json();
    if (!data.text) { toast('No cached report yet ‚Äî click GET AI SAFETY REPORT first', 'info'); return; }
    renderAIReport(data);
    toast('Loaded cached AI report', 'info');
  } catch(e) {
    toast('No cached report available', 'info');
  }
}

function renderAIReport(data) {
  var rawText = data.text || data.explanation || '';

  // Detect if RAG was used from prefix or rag_used flag
  var ragUsed = data.rag_used || rawText.indexOf('[RAG-powered') === 0;

  // Strip the prefix tag from display text ‚Äî show clean report to user
  var cleanText = rawText
    .replace(/^\[RAG-powered[^\]]*\]\s*/i, '')
    .replace(/^\[Pathway LLM xPack[^\]]*\]\s*/i, '')
    .replace(/^\[Direct LLM[^\]]*\]\s*/i, '')
    .replace(/^\[OpenRouter fallback\]\s*/i, '')
    .trim();

  document.getElementById('aiExplainText').textContent = cleanText;
  document.getElementById('aiRiskScore').textContent = parseFloat(data.risk_score || 0).toFixed(2);
  document.getElementById('aiRiskLevel').textContent = data.risk_level || '‚Äî';

  var ts = data.generated_at ? new Date(data.generated_at).toLocaleTimeString() : '‚Äî';
  document.getElementById('aiGeneratedAt').textContent = 'Generated: ' + ts;

  document.getElementById('aiExplainBox').style.display = 'block';

  // Show/hide RAG-specific UI
  if (ragUsed) {
    document.getElementById('aiRagBadge').style.display = 'inline-block';
    document.getElementById('aiReportSourceBadge').style.display = 'inline-block';
    document.getElementById('aiRagContextRow').style.display = 'block';
    document.getElementById('aiRagContextText').textContent =
      'OSHA safety rules retrieved from live Pathway DocumentStore (BM25 + KNN index) and injected into LLM prompt.';
    // Update RAG dot to live
    var dot = document.getElementById('ragDot');
    dot.className = 'rag-dot live';
  } else {
    document.getElementById('aiRagBadge').style.display = 'none';
    document.getElementById('aiReportSourceBadge').style.display = 'none';
    document.getElementById('aiRagContextRow').style.display = 'none';
  }

  // Add to terminal
  addTerminalLine('AI', 'Report generated | rag=' + (ragUsed ? 'YES' : 'NO') + ' | risk=' + parseFloat(data.risk_score || 0).toFixed(2), ragUsed ? 'green' : 'yellow');
}

async function pushManualEvent() {
  var violation_type = document.getElementById('manualViolation').value;
  var zone = document.getElementById('manualZone').value;
  var confidence = parseFloat(document.getElementById('manualConf').value);
  var camera_id = document.getElementById('manualCam').value;
  try {
    var res = await apiFetch('/event', {
      method: 'POST',
      body: JSON.stringify({ violation_type: violation_type, zone: zone, confidence: confidence, camera_id: camera_id })
    });
    if (!res.ok) throw new Error();
    toast('‚ö° Event pushed to Pathway: ' + violation_type + ' @ ' + zone, 'success');
  } catch(e) {
    toast('Push failed. Check backend connection.', 'error');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LIVE CAMERA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var liveCamStream = null;
var liveCamInterval = null;
var cameraActive = false;
var snapCooldown = false;

async function toggleLiveCamera() {
  if (cameraActive) {
    stopLiveCamera();
  } else {
    await startLiveCamera();
  }
}

async function startLiveCamera() {
  try {
    liveCamStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
  } catch(e1) {
    try {
      liveCamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    } catch(e2) {
      toast('Camera access denied. Allow camera in browser settings.', 'error');
      return;
    }
  }

  var video = document.getElementById('liveCamFeed');
  video.srcObject = liveCamStream;
  video.style.display = 'block';

  await new Promise(function(resolve) {
    video.onloadedmetadata = function() { video.play(); resolve(); };
  });

  document.getElementById('liveCamPlaceholder').style.display = 'none';
  document.getElementById('camLiveBadge').classList.add('active');
  document.getElementById('liveCamTag').style.display = 'inline-block';
  document.getElementById('liveCamBtn').textContent = 'STOP CAMERA';
  document.getElementById('liveCamBtn').style.background = 'var(--red-dim)';
  document.getElementById('snapBtn').disabled = false;
  document.getElementById('liveCamStatusText').textContent = 'üî¥ Auto-analyzing every 5 seconds via YOLO...';
  cameraActive = true;

  liveCamInterval = setInterval(snapAndAnalyze, 5000);
  toast('Camera active ‚Äî YOLO scanning every 5s', 'success');
}

function stopLiveCamera() {
  if (liveCamStream) {
    liveCamStream.getTracks().forEach(function(t) { t.stop(); });
    liveCamStream = null;
  }
  if (liveCamInterval) {
    clearInterval(liveCamInterval);
    liveCamInterval = null;
  }
  cameraActive = false;

  var video = document.getElementById('liveCamFeed');
  video.srcObject = null;
  video.style.display = 'none';

  document.getElementById('liveCamPlaceholder').style.display = 'flex';
  document.getElementById('camLiveBadge').classList.remove('active');
  document.getElementById('liveCamTag').style.display = 'none';
  document.getElementById('liveCamBtn').textContent = 'START CAMERA';
  document.getElementById('liveCamBtn').style.background = '';
  document.getElementById('snapBtn').disabled = true;
  document.getElementById('liveCamStatusText').textContent = 'Camera stopped.';
}

async function snapAndAnalyze() {
  if (!cameraActive || snapCooldown) return;
  var video = document.getElementById('liveCamFeed');
  if (!video || video.readyState < 2) return;

  snapCooldown = true;
  setTimeout(function() { snapCooldown = false; }, 1000);

  var flashEl = document.getElementById('camSnapOverlay');
  flashEl.classList.add('flash');
  setTimeout(function() { flashEl.classList.remove('flash'); }, 150);

  var canvas = document.getElementById('liveCamCanvas');
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  var ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  canvas.toBlob(async function(blob) {
    if (!blob || !authToken) return;
    var formData = new FormData();
    formData.append('file', blob, 'live_snapshot.jpg');

    try {
      var res = await fetch(API_BASE + '/detect/image', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + authToken },
        body: formData
      });
      if (!res.ok) return;
      var data = await res.json();

      showDetectionResult(data, 1);

      if (data.violations && data.violations.length > 0) {
        showViolationAlert(data.violations, data.risk_score);
      }

      var ts = new Date().toLocaleTimeString();
      var count = (data.violations && data.violations.length) || 0;
      document.getElementById('liveCamStatusText').textContent =
        'üî¥ Last scan: ' + ts + ' ‚Äî ' + count + ' violation(s) found';

    } catch(e) {
      // silent
    }
  }, 'image/jpeg', 0.85);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VIOLATION ALERT POPUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var popupDismissTimer = null;

function showViolationAlert(violations, riskScore) {
  var existing = document.getElementById('violationAlertPopup');
  if (existing) {
    existing.remove();
    if (popupDismissTimer) { clearTimeout(popupDismissTimer); popupDismissTimer = null; }
  }

  var risk = parseFloat(riskScore || 0);
  var isCritical = risk > 50 || violations.some(function(v) {
    return v.type === 'fire' || v.type === 'smoke';
  });

  var accentColor = isCritical ? 'var(--red)' : 'var(--yellow)';
  var titleText = isCritical ? 'üö® CRITICAL VIOLATION DETECTED' : '‚ö†Ô∏è SAFETY VIOLATION DETECTED';
  var popupClass = isCritical ? 'violation-popup critical' : 'violation-popup warning';

  var icons = { no_helmet: 'ü™ñ', no_vest: 'ü¶∫', fire: 'üî•', smoke: 'üí®', restricted_zone: '‚õî' };

  var rows = violations.map(function(v) {
    var conf = (v.confidence * 100).toFixed(1);
    var icon = icons[v.type] || '‚ö†Ô∏è';
    return '<div class="popup-viol-row">' +
      '<span class="popup-viol-icon">' + icon + '</span>' +
      '<span class="popup-viol-name">' + v.type.replace(/_/g, ' ').toUpperCase() + '</span>' +
      '<span class="popup-viol-conf" style="color:' + accentColor + '">' + conf + '%</span>' +
      '<span class="popup-viol-zone">' + (v.zone || '') + '</span>' +
    '</div>';
  }).join('');

  var popup = document.createElement('div');
  popup.id = 'violationAlertPopup';
  popup.className = popupClass;
  popup.innerHTML =
    '<div class="popup-header">' +
      '<div class="popup-title">' +
        '<div class="popup-title-dot" style="background:' + accentColor + ';"></div>' +
        '<span class="popup-title-text" style="color:' + accentColor + '">' + titleText + '</span>' +
      '</div>' +
      '<button class="popup-close" onclick="dismissViolationAlert()">‚úï</button>' +
    '</div>' +
    rows +
    '<div class="popup-footer">' +
      '<span class="popup-risk">RISK SCORE: <strong style="color:' + accentColor + '">' + risk.toFixed(2) + '</strong></span>' +
      '<span class="popup-time">' + new Date().toLocaleTimeString() + '</span>' +
    '</div>' +
    (!isCritical ?
      '<div class="popup-dismiss-bar"><div class="popup-dismiss-fill" style="background:' + accentColor + '"></div></div>'
    : '');

  document.body.appendChild(popup);

  if (!isCritical) {
    popupDismissTimer = setTimeout(dismissViolationAlert, 6000);
  }
}

function dismissViolationAlert() {
  var popup = document.getElementById('violationAlertPopup');
  if (popup) {
    popup.style.opacity = '0';
    popup.style.transition = 'opacity .3s';
    setTimeout(function() { if (popup.parentNode) popup.remove(); }, 300);
  }
  if (popupDismissTimer) { clearTimeout(popupDismissTimer); popupDismissTimer = null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DRAG & DROP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
['imageDropZone', 'videoDropZone'].forEach(function(id) {
  var zone = document.getElementById(id);
  zone.addEventListener('dragover', function(e) { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', function() { zone.classList.remove('dragover'); });
  zone.addEventListener('drop', function(e) {
    e.preventDefault();
    zone.classList.remove('dragover');
    var file = e.dataTransfer.files[0];
    if (!file) return;
    if (id === 'imageDropZone' && file.type.startsWith('image/')) {
      selectedImage = file;
      var imgUrl = URL.createObjectURL(file);
      var wrap = document.getElementById('imagePreviewWrap');
      wrap.style.display = 'block';
      wrap.innerHTML = '<img src="' + imgUrl + '">';
    } else if (id === 'videoDropZone' && file.type.startsWith('video/')) {
      selectedVideo = file;
      var vidUrl = URL.createObjectURL(file);
      var wrap2 = document.getElementById('videoPreviewWrap');
      wrap2.style.display = 'block';
      wrap2.innerHTML = '<video src="' + vidUrl + '" controls></video>';
    }
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type) {
  type = type || 'info';
  var container = document.getElementById('toastContainer');
  var t = document.createElement('div');
  t.className = 'toast ' + type;
  t.textContent = msg;
  container.appendChild(t);
  setTimeout(function() {
    t.style.opacity = '0';
    t.style.transition = 'opacity .3s';
    setTimeout(function() { if (t.parentNode) t.remove(); }, 300);
  }, 3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ENTER KEY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('loginPassword').addEventListener('keydown', function(e) { if (e.key === 'Enter') doLogin(); });
document.getElementById('loginEmail').addEventListener('keydown', function(e) { if (e.key === 'Enter') doLogin(); });
</script>
</body>
</html>